# 同時実行制御について説明できる

## 同時実行制御

同時実行制御（Concurrency control）は、データベースシステムで複数のトランザクションが同時に実行される際に、

データの整合性と一貫性を保つための技術です。これにより、データベースでの競合状態やデータの破損が防がれます。

---

例として、銀行の口座システムを考えてみてください。

2 人の顧客 A と B が、それぞれ異なる端末から同じ口座にアクセスして、お金を引き出そうとしているとします

顧客 A がまず 1 万円引き出すことに成功し、口座残高が 9 万円になります。

一方、顧客 B も同時に 1 万円引き出そうとしているときに、同時実行制御が適切に機能していなければ、

口座残高が正しく更新されず、意図しない結果が生じる可能性があります。

---

同時実行制御は、こういった問題を防ぐために、データベースシステムで実装されています。

主な方法には、ロック（Locking）、タイムスタンプベースの方法（Timestamp-based method）や、

最適化された同時実行制御（Optimistic Concurrency Control）などがあります。

これらの方法を用いることで、データベースシステムは複数のトランザクションが同時に実行されても、

データの整合性と一貫性を維持できるようになります。

---

## ACID 特性

ACID 特性は、データベーストランザクションが持つべき 4 つの重要な特性を表す言葉です。

これらの特性が満たされることで、データベースシステムはデータの整合性と一貫性を保ち、信頼性を維持できます。

ACID は以下の頭文字を取っています。

---

原子性（Atomicity）：トランザクションは「全部か無し」で実行され、すべての操作が成功するか、失敗時は取り消されます。

これにより、データの整合性が保たれます。

---

一貫性(Consistency)：トランザクションはデータベースの状態を一貫した状態から別の一貫した状態へ遷移させ、データの整合性が維持されます。

---

独立性（Isolation）：同時に実行される複数のトランザクションが互いに影響を与えずに実行され、データの安全性が保たれます。

---

永続性(Durability):トランザクションが正常に完了した後、その結果はデータベースに永続的に保存され、データの信頼性が維持されます。

---

これらの特性により、データベースシステムはデータの整合性と一貫性を保ち、信頼性の高いデータ操作が可能になります。

---

## ロック

ロックとは、データベースシステムにおいて、同時に複数のトランザクションが実行される際に、

データの整合性と一貫性を保つために使用される同時実行制御の一手法です。ロックは、トランザクションがデータにアクセスする際に、

他のトランザクションからのアクセスを一時的に制限することで、データの競合や不整合を防ぎます。

---

例です、以下のシナリオを考えてみてください。

あるオンラインショッピングサイトで、2 人のユーザー A と B が同時に限定品を購入しようとしています。

在庫が 1 つしかない場合、どちらか 1 人だけが購入できるようにしなければなりません。

ここでロックが役立ちます。ユーザー A が購入処理を開始すると、データベースシステムは在庫データに対してロックをかけます。

これにより、ユーザー B が同時に購入処理を開始しようとしても、ロックが解除されるまで在庫データにアクセスできません。

ユーザー A の購入処理が完了し、在庫が減らされた後でロックが解除されると、ユーザー B は在庫がないことが確認でき、

購入できないことがわかります。

---

ロックには主に 2 つの種類があります。

共有ロック（Shared Lock）：複数のトランザクションがデータを読み取ることができますが、書き込みは許可されません。

これにより、他のトランザクションがデータを変更することなく、安全に読み取ることができます。

---

排他ロック（Exclusive Lock）：データに対して排他ロックがかけられた場合、

そのデータはロックをかけたトランザクションによってのみ読み取り・書き込みが可能です。

---

他のトランザクションは、ロックが解除されるまでデータにアクセスできません。

ロックを適切に使用することで、データベースシステムは同時実行制御を実現し、データの整合性と一貫性を保つことができます。

---

## ロックの確認

ロックの挙動を確認しましょう。

ターミナルを 2 つ開き、両方とも employees データベースに接続してください。

片方のターミナル（ターミナル 1）で、トランザクションを開始してください。給与テーブルに対して、従業員番号が 10001 で、開始日が 1986-06-26 の従業員の給与を 70000 に更新してください。

もう片方のターミナル（ターミナル 2）で、給与テーブルに対して、従業員番号が 10001 で、開始日が 1986-06-26 の従業員の給与を 2 倍に更新してください。こちらのターミナルはクエリを実行されたまま停止することを確認してください。

ターミナル 1 で、従業員番号が 10001 で、開始日が 1986-06-26 の従業員の給与を検索してください。給与が 70000 のままロックされていることを確認しましょう。

ターミナル 1 で、コミットをします。

ターミナル 2 を開いてください。クエリが実行されているはずです。ターミナル 2 から従業員番号が 10001 で、開始日が 1986-06-26 の従業員の給与を検索してください。給与が 2 倍に更新されているはずです。

これがロックの基本の挙動です。他にもクエリを色々試してみて、ロックの挙動を確認してみてください。
